# Лабораторная работа №7: Мокирование API с помощью Mountebank

## Описание

Данная лабораторная работа демонстрирует использование **Mountebank** для создания mock-сервера, который имитирует API для получения курсов валют. Mock-сервер позволяет тестировать приложение без обращения к реальному внешнему API, что ускоряет тесты и делает их независимыми от внешних сервисов.

## Что такое Mock?

**Mock (мок)** — это имитация реального сервиса или компонента, которая возвращает предопределенные ответы. В данном случае mock-сервер имитирует API для получения курсов валют, позволяя:

- Не обращаться к реальному внешнему API при каждом запуске тестов
- Работать с предсказуемыми данными
- Тестировать приложение быстрее и независимо от доступности внешних сервисов
- Симулировать различные сценарии (успешные запросы, ошибки и т.д.)

## Что такое Mountebank?

**Mountebank** — это инструмент для создания mock-серверов, который позволяет:
- Создавать виртуальные серверы (импостеры) с заданными ответами
- Имитировать HTTP, HTTPS, TCP и другие протоколы
- Настраивать сложные сценарии ответов на основе условий (предикатов)

## Структура проекта

```
lab7/
├── main.py              # Основной файл с тестами
├── imposter.json        # Конфигурация mock-сервера для Mountebank
├── requirements.txt     # Зависимости Python
├── .gitignore          # Игнорируемые файлы для git
└── README.md           # Этот файл
```

## Установка и запуск

### Шаг 1: Установка зависимостей Python

```bash
pip install -r requirements.txt
```

Или установите вручную:
```bash
pip install pytest requests
```

### Шаг 2: Установка Mountebank

**Вариант 1: Через npm (рекомендуется)**

1. Установите Node.js с [официального сайта](https://nodejs.org/)
2. Установите Mountebank:
```bash
npm install -g mountebank
```

**Вариант 2: Через Docker**

```bash
docker run -p 2525:2525 -p 4545:4545 bbyars/mountebank:2.9.1
```

### Шаг 3: Запуск Mountebank

В отдельном терминале запустите:
```bash
mb --port 2525
```

Mountebank будет слушать на порту 2525 и готов к созданию mock-серверов.

### Шаг 4: Запуск тестов

В другом терминале выполните:
```bash
pytest main.py -v
```

## Как это работает?

### 1. Конфигурация Mock-сервера (imposter.json)

Файл `imposter.json` содержит конфигурацию для создания mock-сервера. Структура файла:

- **port**: 4545 — порт, на котором будет работать mock-сервер
- **protocol**: "http" — протокол (HTTP)
- **name**: "Currency Mock" — имя mock-сервера
- **stubs**: массив правил (stub), каждое правило содержит:
  - **predicates**: условия, при которых срабатывает правило (метод, путь, параметры запроса)
  - **responses**: ответы, которые возвращает сервер при совпадении условий

#### Примеры правил:

**Правило для USD → EUR:**
- Условие: GET запрос на `/rate?from=USD&to=EUR`
- Ответ: `{"from": "USD", "to": "EUR", "rate": 0.91}` со статусом 200

**Правило для несуществующих валют:**
- Условие: любой запрос, который не совпал с предыдущими правилами
- Ответ: `{"error": "Currency not supported"}` со статусом 404

### 2. Процесс работы тестов

1. **Фикстура `fxtr_currency_rates`** (выполняется перед тестами):
   - Удаляет старый импостер на порту 4545 (если существует)
   - Загружает конфигурацию из `imposter.json`
   - Отправляет POST-запрос в Mountebank для создания нового импостера
   - Mountebank создает mock-сервер на порту 4545

2. **Выполнение тестов**:
   - Тесты отправляют GET-запросы на `http://localhost:4545/rate`
   - Mock-сервер проверяет параметры запроса (from, to)
   - Возвращает соответствующий ответ из конфигурации
   - Тесты проверяют, что полученный курс совпадает с ожидаемым

3. **Очистка** (выполняется после тестов):
   - Фикстура удаляет импостер, освобождая порт

### 3. Тесты

**Параметризованный тест `test_currency_rat`:**
- Проверяет 8 различных валютных пар
- Для каждой пары проверяет, что полученный курс совпадает с ожидаемым

**Тест `test_invalid_currency`:**
- Проверяет обработку ошибок
- Отправляет запрос с несуществующими валютами (XYZ, ABC)
- Проверяет, что сервер возвращает ошибку 404

## Преимущества использования Mock

1. **Скорость**: Не нужно ждать ответа от реального API
2. **Надежность**: Тесты не зависят от доступности внешних сервисов
3. **Предсказуемость**: Всегда получаем одинаковые ответы
4. **Изоляция**: Тесты не влияют на реальные данные
5. **Гибкость**: Можно легко симулировать различные сценарии (ошибки, задержки и т.д.)

## Структура imposter.json (подробно)

### Основная структура:

```json
{
  "port": 4545,              // Порт mock-сервера
  "protocol": "http",        // Протокол (http/https/tcp)
  "name": "Currency Mock",   // Имя для идентификации
  "stubs": [...]            // Массив правил обработки запросов
}
```

### Структура stub (правила):

Каждый stub состоит из двух частей:

1. **predicates** (предикаты) — условия, при которых правило срабатывает:
   ```json
   "predicates": [{
     "equals": {
       "method": "GET",           // HTTP метод
       "path": "/rate",           // Путь запроса
       "query": {                 // Параметры запроса
         "from": "USD",
         "to": "EUR"
       }
     }
   }]
   ```

2. **responses** (ответы) — что возвращает сервер:
   ```json
   "responses": [{
     "is": {
       "statusCode": 200,         // HTTP статус код
       "headers": {                // Заголовки ответа
         "Content-Type": "application/json"
       },
       "body": {                   // Тело ответа (JSON)
         "from": "USD",
         "to": "EUR",
         "rate": 0.91
       }
     }
   }]
   ```

### Правила в конфигурации:

1. **USD → EUR**: курс 0.91
2. **EUR → USD**: курс 1.10
3. **EUR → RUB**: курс 95.04
4. **USD → RUB**: курс 86.17
5. **RUB → USD**: курс 0.012
6. **RUB → EUR**: курс 0.01
7. **EUR → CHF**: курс 0.93
8. **CHF → EUR**: курс 1.08
9. **Любые другие валюты**: ошибка 404 "Currency not supported"

Последнее правило не имеет предикатов, поэтому срабатывает для всех запросов, которые не совпали с предыдущими правилами (default response).

## Результаты выполнения

При успешном выполнении все 9 тестов должны пройти:

```
9 passed in 0.10s
```

- 8 параметризованных тестов для различных валютных пар
- 1 тест для проверки обработки ошибок

## Полезные ссылки

- [Документация Mountebank](http://www.mbtest.org/)
- [Документация pytest](https://docs.pytest.org/)
- [Документация requests](https://requests.readthedocs.io/)

## Автор

Лабораторная работа выполнена для демонстрации использования Mock-серверов в тестировании.

